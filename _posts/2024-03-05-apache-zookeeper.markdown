---
layout: post
title: "Apache Zookeeper"
date: 2024-03-05 19:07:01 +0900
categories: [ zookeeper ]
---

# Apache Zookeeper

zookeeper 는 설정 정보나, 네이밍, 분산 시스템 동기화, 그루핑 서비스를 제공하는 중앙 집중화된 서비스이다. (**코디네이션 서비스라고도 함**)

## 아키텍쳐

![Desktop View](/assets/img/2024-03-05/zookeeper-architecture.png){: width="972" height="589" }

주키퍼는 Leader-Follower 로 구성되어 있다. 이렇게 구성된 클러스터를 앙상블이라고 한다. 앙상블 내에서, 데이터의 정합성은 퀴럼이라는 조직을 통해서 이루어진다.
각각의 주피터 노드는 znode 라고 불리는 데이터 모델로 구성되어 있다. 이 데이터 모델을 정합성 있게 제공하는 것이 주키퍼의 핵심이다.

### 앙상블

앙상블 안의 주키퍼 서버들은 항상 동일한 데이터를 갖고 있다. 어떤 주키퍼 서버에서 데이터를 읽더라도, 외부의 클라이언트는 같은 데이터를 전달받을 수 있다.
<br>
주키퍼 서버 안의 데이터가 변경되어야 한다면, leader 에게 전달된다. leader 는 전달받은 데이터를 업데이트하기 위해 퀴럼을 모은다. 퀴럼은 앙상블 내의 과반수를 의미한다. 퀴럼의 상태가 리더와
동기화된다면 이제 변경은 저장된다. 그리고, 업데이트를 호출한 쪽은 업데이트가 성공했다는 응답을 받을 수 있다.

### Watcher

zookeeper 는 znode 에 변화를 감지할 수 있는 watcher 를 클라이언트로 하여금 설정할 수 있다. watcher 는 자신이 감시하는 znode 의 수정을 감지해서, 클라이언트로 하여금 callback 호출을 할 수 있도록 알림을 제공한다.

### 리더 선출

앙상블 내에서는 자동으로 리더가 선출된다. 퀴럼 팔로워의 상태가 리더와 동기화된다면, 리더 선출 단계가 완료된다.
리더에 문제가 생긴다면 재선출이 일어나는데, 이 과정은 200ms 이내로 매우 빠르게 이뤄진다.

### znode(Zookeeper node)

znode 는 linux 파일 시스템과 유사한 형태를 띄고 있다. 클라이언트가 보는 것은 이 znode 가 담고 있는 데이터라고 할 수 있다.
앙상블의 모든 서버는 업데이트 사항을 znode 트리의 메모리 복사본에 기록하며, 디스크에도 기록된다. 읽기 요청에 대해서는 메모리에 있는 내용을 검색해서 반환하므로 속도가 매우 빠르다.
<br>
znode 에는 3가지 종류가 있다.

- persistent node : 영구 저장소
- ephermeral node : 클라이언트가 종료되면 사라지는 저장소
- sequential node : 생성 뒤에 순차적인 10자리 숫자가 붙는 저장소

영구 저장소는 znode 클러스터 관리 로직을 구현하기 위해서 사용된다. 임시 znode 는 리더 선출을 위해서 사용된다. 순열 znode 는 lock 을 구현하거나, 글로벌 큐를 구현할 때 사용된다.

